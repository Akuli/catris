<!DOCTYPE html>
<html>
  <head>
    <script>
      const ws = new WebSocket('ws://localhost:54321');

      document.onkeydown = event => {
        if (ws.readyState !== WebSocket.OPEN) {
          return;
        }

        let textToSend;
        if (event.key.length === 1) {
          textToSend = event.key;
        } else if (event.key === "ArrowUp") {
          textToSend = "\x1b[A";
        } else if (event.key === "ArrowDown") {
          textToSend = "\x1b[B";
        } else if (event.key === "ArrowRight") {
          textToSend = "\x1b[C";
        } else if (event.key === "ArrowLeft") {
          textToSend = "\x1b[D";
        } else if (event.key === "Backspace") {
          textToSend = "\x7f";
        } else if (event.key === "Enter") {
          textToSend = "\r";
        } else {
          console.log(event.key);
          return;
        }

        const utf8 = new TextEncoder().encode(textToSend);
        ws.send(utf8);

        event.preventDefault();
      };

      // For some reason, the .text() method on Blob is asynchronous.
      // We need to make sure they run in the correct order, and not at the same time.
      let receivedBlobs = [];
      let blobTask = null;

      async function handleBlobs() {
        while (receivedBlobs.length !== 0) {
          const blobs = receivedBlobs;
          receivedBlobs = [];
          const texts = await Promise.all(blobs.map(b => b.text()));
          document.body.textContent += texts.join("");
        }
      }

      ws.onmessage = (msg) => {
        receivedBlobs.push(msg.data);
        if (blobTask === null) {
          blobTask = handleBlobs();
          blobTask.then(() => blobTask=null);
        }
      };
      ws.onerror = event => {
        console.log("WebSocket error: ", event);
        document.body.innerHTML = "Connection to server lost.";
      };
      ws.onclose = () => {
        console.log("onclose callback runs");
        document.body.innerHTML = "Connection to server lost.";
      };
    </script>
  </head>
  <body>
    asdf
  </body>
</html>
